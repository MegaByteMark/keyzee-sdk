name: ðŸš€ Build Test Tag Release Publish ðŸš€

on:
#   push:
#     branches:
#       - main
  workflow_dispatch:

jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    
    steps:
      - name: ðŸ§‘â€ðŸ’» Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: ðŸ¤– Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
      
      - name: ðŸ”§ Install EF Core Tools
        run: dotnet tool install --global dotnet-ef
      
      - name: ðŸ”§ Add tools to PATH
        run: echo "/root/.dotnet/tools" >> $GITHUB_PATH
      
      # Run build-script.sh to restore, build, test and generate migration bundles for all providers.
      - name: ðŸ”§ Make build script executable
        run: chmod +x ./build-script.sh

      - name: ðŸ™ˆ Run build-script.sh
        run: ./build-script.sh

      # Pack the KeyZee project for NuGet publishing
      - name: ðŸ¤– Pack
        run: dotnet pack ./keyzee/keyzee.csproj --configuration Release --no-build --output ./nupkg
      
      - name: ðŸª¾ Create Git Tag
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git tag v${{ steps.get_version.outputs.VERSION }}
          git push origin v${{ steps.get_version.outputs.VERSION }}
      
      - name: ðŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.get_version.outputs.VERSION }}
          files: |
            ./nupkg/*.nupkg
            ./bundles/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ðŸ™Š Publish to NuGet
        run: dotnet nuget push ./nupkg/*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate
        env:
          NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}
